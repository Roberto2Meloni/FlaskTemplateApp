<div class="sockets-container">
  <!-- Header -->
  <div class="sockets-header">
    <div class="header-left">
      {% if not app_config.socketio_enabled %}
      <h2 style="color: red">SocketIO nicht aktiviert</h2>
      {% else %}
      <h4><i class="bi bi-plug-fill"></i> Socket Verbindungen</h4>
      <p class="sockets-subtitle">
        Aktive WebSocket-Verbindungen für {{ app_config.app_name }}
      </p>
      {% endif %}
    </div>

    {% if app_config.socketio_enabled %}
    <div class="header-right">
      <button id="refreshBtn" class="btn btn-secondary">
        <i class="bi bi-arrow-clockwise"></i> Aktualisieren
      </button>
      <button id="disconnectAllBtn" class="btn btn-danger">
        <i class="bi bi-x-circle"></i> Alle trennen
      </button>
    </div>
    {% endif %}
  </div>

  {% if app_config.socketio_enabled %}

  <!-- ========================================
       SOCKET STATUS & TEST - ACCORDION
       ======================================== -->
  <div class="socket-test-section">
    <div class="test-card">
      <!-- Header klickbar → Accordion -->
      <div class="test-card-header">
        <h5>
          <i class="bi bi-activity"></i> Socket Status & Tests
          <i
            class="bi bi-chevron-down"
            id="testSectionChevron"
            style="float: right; margin-top: 2px"
          ></i>
        </h5>
      </div>

      <!-- Body: wird per JS eingeklappt -->
      <div class="test-card-body" id="testSectionBody" style="display: none">
        <!-- Connection Status -->
        <div class="connection-status">
          <div class="status-indicator">
            <div id="socketStatus" class="status-badge offline">
              <span class="status-dot"></span>
              <span class="status-text">Getrennt</span>
            </div>
            <div id="socketId" class="socket-info">Socket ID: -</div>
          </div>
          <div id="lastPing" class="last-activity">Letzter Ping: -</div>
        </div>

        <!-- Test Buttons -->
        <div class="test-buttons">
          <button
            id="connectBtn"
            class="btn btn-success"
            onclick="testSocketConnect()"
          >
            <i class="bi bi-plug"></i> Verbinden
          </button>
          <button
            id="pingBtn"
            class="btn btn-primary"
            onclick="testSocketPing()"
            disabled
          >
            <i class="bi bi-lightning"></i> Ping senden
          </button>
          <button
            id="disconnectBtn"
            class="btn btn-warning"
            onclick="testSocketDisconnect()"
            disabled
          >
            <i class="bi bi-plug-fill"></i> Trennen
          </button>
        </div>

        <!-- Test Log -->
        <div class="test-log-section">
          <div class="test-log-header">
            <span>Event Log</span>
            <button class="btn-small" onclick="clearTestLog()">
              <i class="bi bi-trash"></i> Löschen
            </button>
          </div>
          <div id="testLog" class="test-log">
            <div class="log-entry log-info">
              <span class="log-time">--:--:--</span>
              <span class="log-message">Bereit für Tests...</span>
            </div>
          </div>
        </div>
      </div>
      <!-- /testSectionBody -->
    </div>
  </div>

  <!-- Custom SocketIO Include -->
  {% include "_custom/admin/include/Template_app_v002_include_socketio.html" %}

  <!-- ========================================
       STATISTICS CARDS
       ======================================== -->
  <div class="sockets-stats">
    <div class="stat-card stat-primary">
      <div class="stat-icon"><i class="bi bi-broadcast"></i></div>
      <div class="stat-content">
        <div class="stat-value" id="totalConnections">
          {{ active_sockets|length }}
        </div>
        <div class="stat-label">Aktive Verbindungen</div>
      </div>
    </div>

    <div class="stat-card stat-success">
      <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
      <div class="stat-content">
        <div class="stat-value" id="onlineUsers">
          {{ online_users_count|default(0) }}
        </div>
        <div class="stat-label">Online Benutzer</div>
      </div>
    </div>

    <div class="stat-card stat-info">
      <div class="stat-icon"><i class="bi bi-graph-up"></i></div>
      <div class="stat-content">
        <div class="stat-value">
          {% if online_users_count and online_users_count > 0 %} {{
          (active_sockets|length / online_users_count) | round(1) }} {% else %}
          {{ active_sockets|length }} {% endif %}
        </div>
        <div class="stat-label">Ø Verbindungen/User</div>
      </div>
    </div>
  </div>

  <!-- ========================================
       SOCKETS TABLE
       ======================================== -->
  <div class="sockets-content">
    {% if active_sockets %}
    <div class="sockets-table-card">
      <div class="table-header">
        <h5><i class="bi bi-table"></i> Verbindungsdetails</h5>
      </div>

      <div class="sockets-table-wrapper">
        <table class="sockets-table" id="socketsTable">
          <thead>
            <tr>
              <th><i class="bi bi-person-fill"></i> Benutzer</th>
              <th><i class="bi bi-fingerprint"></i> Socket ID</th>
              <th><i class="bi bi-clock-history"></i> Verbunden seit</th>
              <th class="text-center">
                <i class="bi bi-gear-fill"></i> Aktionen
              </th>
            </tr>
          </thead>
          <tbody id="socketsTableBody">
            {% for sid, socket in active_sockets.items() %}
            <tr
              data-sid="{{ sid }}"
              data-type="{% if socket.user_id %}auth{% else %}guest{% endif %}"
            >
              <!-- Benutzer -->
              <td>
                <div class="user-cell">
                  <div class="user-avatar">
                    {% if socket.user_id %}
                    <i class="bi bi-person-circle text-primary"></i>
                    {% else %}
                    <i class="bi bi-person-circle text-secondary"></i>
                    {% endif %}
                  </div>
                  <div class="user-info">
                    <div class="username">{{ socket.username }}</div>
                    <div class="user-meta">
                      {% if socket.user_id %}
                      <span class="badge badge-success">
                        <i class="bi bi-shield-check"></i> Authentifiziert
                      </span>
                      <span class="user-id">ID: {{ socket.user_id }}</span>
                      {% else %}
                      <span class="badge badge-secondary">
                        <i class="bi bi-person"></i> Gast
                      </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </td>

              <!-- Socket ID -->
              <td>
                <div class="socket-id-cell">
                  <code class="socket-id">{{ sid[:12] }}...</code>
                  <button
                    class="copy-btn"
                    onclick="navigator.clipboard.writeText('{{ sid }}').then(() => AppAdmin.showToast('SID kopiert', 'success'))"
                    title="Kopieren"
                  >
                    <i class="bi bi-clipboard"></i>
                  </button>
                </div>
              </td>

              <!-- Verbunden seit -->
              <td>
                <div class="timestamp-cell">
                  <i class="bi bi-calendar3"></i>
                  <span
                    class="timestamp"
                    data-timestamp="{{ socket.connected_at }}"
                  >
                    {{ socket.connected_at }}
                  </span>
                </div>
              </td>

              <!-- Aktionen -->
              <td class="text-center">
                <div class="action-buttons">
                  <button
                    class="btn-action btn-danger"
                    onclick="AppAdmin.disconnectSocket('{{ sid }}', this)"
                    title="Verbindung trennen"
                  >
                    <i class="bi bi-x-circle"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="table-footer">
        <div class="showing-info">
          Zeige
          <strong id="visibleCount">{{ active_sockets|length }}</strong> von
          <strong>{{ active_sockets|length }}</strong> Verbindungen
        </div>
      </div>
    </div>

    {% else %}
    <div class="empty-state">
      <div class="empty-icon"><i class="bi bi-plug"></i></div>
      <h5>Keine aktiven Verbindungen</h5>
      <p>Aktuell sind keine Socket-Verbindungen für diese App aktiv.</p>
      <button class="btn btn-primary" onclick="AppAdmin.refreshSocketList()">
        <i class="bi bi-arrow-clockwise"></i> Aktualisieren
      </button>
    </div>
    {% endif %}
  </div>

  {% else %}
  <!-- SocketIO deaktiviert -->
  <div class="socket-test-section">
    <div class="test-card">
      <div
        class="test-card-header"
        style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)"
      >
        <h5>
          <i class="bi bi-exclamation-triangle"></i> SocketIO nicht aktiviert
        </h5>
      </div>
      <div class="test-card-body">
        <p>
          SocketIO ist für diese App nicht aktiviert. Aktiviere SocketIO in den
          Konfigurationen um Echtzeit-Verbindungen zu nutzen.
        </p>
      </div>
    </div>
  </div>
  {% endif %}
</div>
